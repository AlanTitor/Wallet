# Тестовое задание: Wallet Service

Это приложение представляет собой реализацию простого сервиса для управления балансом электронных кошельков. Проект разработан в соответствии с тестовым заданием и демонстрирует применение современных подходов к разработке на Java/Spring, включая решение проблем конкурентного доступа и развертывание в Docker.

## Технологический стек
- **Java 17**
- **Spring Boot 3**
- **Spring Data JPA**
- **PostgreSQL** (в качестве базы данных)
- **Liquibase** (для управления миграциями базы данных)
- **Lombok** (для сокращения boilerplate-кода)
- **MapStruct** (для маппинга DTO)
- **Docker & Docker Compose** (для контейнеризации и оркестрации)
- **Maven** (для сборки проекта)

## Ключевые особенности и архитектурные решения

### 1. Обработка конкурентных запросов (Concurrency)
Особое внимание было уделено проблеме "гонки состояний" при одновременном обновлении баланса одного и того же кошелька (1000 RPS). Для решения этой задачи был применен механизм **оптимистической блокировки (Optimistic Locking)**.

- **Как это работает:**
  - В сущность `Wallet` добавлено поле `version` с аннотацией `@Version`.
  - При каждой успешной транзакции обновления кошелька JPA автоматически инкрементирует это поле.
  - Если две транзакции одновременно пытаются обновить одну и ту же запись, первая успешно выполнится и увеличит версию. Вторая транзакция при коммите обнаружит, что версия в базе данных уже изменилась, и выбросит `OptimisticLockException`.
  - Для обработки этой ошибки и предотвращения потери запросов используется механизм повторных попыток Spring Retry (`@Retryable`). Сервис будет автоматически пытаться выполнить операцию несколько раз, пока она не завершится успешно. Это гарантирует, что ни один запрос не будет потерян с 50Х ошибкой.

### 2. Разделение ответственности (CQRS-like подход)
Логика сервиса разделена на две части для лучшей читаемости и поддержки:
- **`WalletCommandService`**: Отвечает за все операции, изменяющие состояние системы (пополнение, списание).
- **`WalletQueryService`**: Отвечает за операции чтения данных (получение баланса, создание нового кошелька).

### 3. Шаблон проектирования "Стратегия"
Для обработки различных типов операций (`DEPOSIT`, `WITHDRAW`) применяется шаблон **Strategy**.
- Создан интерфейс `IWalletOperation` и его реализации `DepositOperation` и `WithdrawOperation`.
- `WalletOperationFactory` инкапсулирует логику выбора нужной стратегии в зависимости от `operationType` из запроса. Это делает систему гибкой и легко расширяемой для добавления новых типов операций в будущем.

### 4. Управление миграциями базы данных
Все изменения схемы базы данных управляются с помощью **Liquibase**. Файлы миграций находятся в директории `src/main/resources/db/changelog`. Это обеспечивает версионирование и предсказуемое состояние БД в любой среде.

### 5. Контейнеризация
Приложение и база данных полностью контейнеризированы с помощью **Docker**. Файл `docker-compose.yml` позволяет поднять всю систему одной командой.

### 6. Детальная обработка ошибок
Реализован `GlobalExceptionHandler` для перехвата различных исключений и возврата клиенту информативных и корректных ответов с соответствующими HTTP-статусами:
- `404 Not Found`: если кошелек не найден.
- `400 Bad Request`:
    - Некорректный JSON в теле запроса.
    - Ошибки валидации (например, отрицательная сумма, отсутствующие поля).
    - Недостаточно средств на счете для списания (`LessThanZeroException`).
    - Неверный формат UUID в пути запроса.

## API Endpoints

### 1. Обновление баланса кошелька
Производит операцию пополнения (`DEPOSIT`) или списания (`WITHDRAW`).

- **Метод:** `POST`
- **URL:** `/api/v1/wallet`
- **Тело запроса (Request Body):**
  ```json
  {
    "id": "c1f7a3f0-1c6e-4b8a-9e3f-4e5e6e7d8c9b",
    "operation": "DEPOSIT",
    "amount": 1000.50
  }
  ```
- **Успешный ответ (Success Response):** `200 OK`
  ```json
  {
    "amount": 11000.50
  }
  ```
- **Ошибки (Error Responses):**
    - `400 Bad Request` - Недостаточно средств, невалидный JSON, ошибки валидации.
    - `404 Not Found` - Кошелек с указанным `id` не существует.

### 2. Получение баланса кошелька
Возвращает текущий баланс кошелька.

- **Метод:** `GET`
- **URL:** `/api/v1/wallets/{WALLET_UUID}`
- **Пример URL:** `/api/v1/wallets/c1f7a3f0-1c6e-4b8a-9e3f-4e5e6e7d8c9b`
- **Успешный ответ (Success Response):** `200 OK`
  ```json
  {
    "amount": 11000.50
  }
  ```
- **Ошибки (Error Responses):**
    - `400 Bad Request` - Если `WALLET_UUID` имеет неверный формат.
    - `404 Not Found` - Кошелек с указанным `id` не существует.

### 3. Создание нового кошелька
Создает новый кошелек с нулевым балансом и возвращает URI для доступа к нему.

- **Метод:** `GET`
- **URL:** `/api/v1/wallet`
- **Успешный ответ (Success Response):**
    - `201 Created`
    - Заголовок `Location` с URL нового кошелька: `http://localhost:8080/api/v1/wallets/d3a8e9b0-2d7f-5c9c-bf4a-5f6f7f8d9a0c`

## Требования для запуска
- **Docker**
- **Docker Compose**

## Инструкция по запуску
1.  **Клонируйте репозиторий:**
    ```bash
    git clone <ссылка_на_ваш_репозиторий>
    cd <имя_папки_проекта>
    ```

2.  **Создайте файл `.env`** в корневой директории проекта и скопируйте в него содержимое из предоставленного файла `.env`. Этот файл содержит переменные окружения для конфигурации базы данных.
    ```env
    DB_USER=user
    DB_PASSWORD=pass
    DB_NAME=name
    ```

3.  **Соберите проект и запустите контейнеры:**
    Выполните команду в корневой директории проекта:
    ```bash
    docker-compose up --build
    ```
    Эта команда:
    - Сначала соберет Docker-образ для PostgreSQL.
    - Затем соберет Java-приложение с помощью Maven внутри Docker-сборщика.
    - Упакует собранное приложение в легковесный Docker-образ.
    - Запустит контейнеры приложения и базы данных.

После успешного запуска приложение будет доступно по адресу `http://localhost:8080`.

## Конфигурация
Приложение и база данных настраиваются с помощью переменных окружения, указанных в файле `docker-compose.yml` и `.env`. Это позволяет изменять параметры (имя пользователя, пароль, имя БД) без пересборки Docker-образов.

- `SPRING_DATASOURCE_URL`: URL для подключения к БД (формируется в `docker-compose.yml`).
- `SPRING_DATASOURCE_USERNAME`: Имя пользователя БД (из `.env`).
- `SPRING_DATASOURCE_PASSWORD`: Пароль пользователя БД (из `.env`).
- `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB`: Параметры для инициализации контейнера PostgreSQL.

## Тестирование
Проект покрыт тестами для проверки корректности работы эндпоинтов и бизнес-логики.
- **Unit-тесты** (`WalletControllerTest`, `WalletServiceTest`): Проверяют логику контроллера и сервисов с использованием моков (`Mockito`).
- **Интеграционный тест** (`WalletConcurrencyTest`): Специальный тест, который эмулирует высокую нагрузку (1000 одновременных запросов на пополнение одного кошелька) для проверки корректности работы механизма оптимистической блокировки.

Чтобы запустить тесты локально, выполните команду:
```bash
mvn test
```
```